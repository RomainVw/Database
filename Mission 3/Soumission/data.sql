
DROP TABLE IF EXISTS CHARACTER CASCADE;
DROP TABLE IF EXISTS ASSOCIATION CASCADE;
DROP TABLE IF EXISTS ORIGINATES CASCADE;
DROP TABLE IF EXISTS BEHAVIOR CASCADE;
DROP TABLE IF EXISTS PSEUDO CASCADE;
DROP TABLE IF EXISTS TIMELESSRELATION CASCADE;
DROP TABLE IF EXISTS DATERELATION CASCADE;
DROP TABLE IF EXISTS RANGERELATION CASCADE;
DROP TABLE IF EXISTS BIRTH CASCADE;
DROP TABLE IF EXISTS DEATH CASCADE;
DROP TABLE IF EXISTS ATTENDS CASCADE;
DROP TABLE IF EXISTS RELATIONLIST CASCADE;
DROP TABLE IF EXISTS EVENTNAME CASCADE;
DROP TABLE IF EXISTS EVENTDESCRIPTION CASCADE;
DROP TABLE IF EXISTS ASSOCIATIONNAME CASCADE;
DROP TABLE IF EXISTS ASSOCIATIONDESCRIPTION CASCADE;
DROP TABLE IF EXISTS MAP CASCADE;
DROP TABLE IF EXISTS PLACE CASCADE;
DROP TABLE IF EXISTS SUBPLACE CASCADE;
DROP TABLE IF EXISTS SQUAREID CASCADE;
DROP TABLE IF EXISTS MAPPEDPLACE CASCADE;
DROP TABLE IF EXISTS EVENT CASCADE;
DROP TYPE IF EXISTS ENHANCEDDATE;
DROP FUNCTION IF EXISTS COMPARE(integer, integer, integer, integer, integer, integer);


CREATE TYPE ENHANCEDDATE as (YEAR INTEGER, MONTH INTEGER, DAY INTEGER);


CREATE FUNCTION COMPARE(integer, integer, integer, integer, integer, integer) 
    RETURNS integer as '    Select CASE WHEN $1 < $4 THEN -1
     	 WHEN $1 > $4 THEN 1
     	 WHEN $2 < $5 THEN -1
     	 WHEN $2 > $5 THEN 1
     	 WHEN $3 < $6 THEN -1
     	 WHEN $3 > $6 THEN 1
     	 ELSE 0
     END;
    '
    LANGUAGE SQL
    IMMUTABLE
    RETURNS NULL ON NULL INPUT;


CREATE TABLE CHARACTER(
  CHARACTERID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  NAME TEXT NOT NULL
);

CREATE TABLE ASSOCIATION(
  CHARACTERID CHARACTER VARYING(10) NOT NULL,
  ASSOCIATIONID CHARACTER VARYING(10) NOT NULL,
  PRIMARY KEY (CHARACTERID,ASSOCIATIONID)
);

CREATE TABLE ORIGINATES(
  CHARACTERID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  PLACEID CHARACTER VARYING(10) NOT NULL
);

CREATE TABLE BEHAVIOR(
  CHARACTERID CHARACTER VARYING(10) NOT NULL,
  BEHAVIOR CHARACTER VARYING(42) NOT NULL,
  PRIMARY KEY (CHARACTERID,BEHAVIOR)
);

CREATE TABLE PSEUDO(
  CALLERID CHARACTER VARYING(10) NOT NULL,
  CALLEDID CHARACTER VARYING(10) NOT NULL,
  PSEUDONYME CHARACTER VARYING(42) NOT NULL,
  PRIMARY KEY (CALLERID,CALLEDID,PSEUDONYME)
);

CREATE TABLE TIMELESSRELATION(
  SOURCE CHARACTER VARYING(10) NOT NULL,
  TARGET CHARACTER VARYING(10) NOT NULL,
  RELATIONID CHARACTER VARYING(10) NOT NULL,
  PRIMARY KEY (SOURCE,TARGET,RELATIONID)
);

CREATE TABLE DATERELATION(
  SOURCE CHARACTER VARYING(10) NOT NULL,
  TARGET CHARACTER VARYING(10) NOT NULL,
  RELATIONID CHARACTER VARYING(10) NOT NULL,
  DATE ENHANCEDDATE NOT NULL,
  PRIMARY KEY (SOURCE,TARGET,RELATIONID,DATE)
);

CREATE TABLE RANGERELATION(
  SOURCE CHARACTER VARYING(10) NOT NULL,
  TARGET CHARACTER VARYING(10) NOT NULL,
  RELATIONID CHARACTER VARYING(10) NOT NULL,
  START ENHANCEDDATE NOT NULL,
  ENDDATE ENHANCEDDATE NOT NULL,
  PRIMARY KEY (SOURCE,TARGET,RELATIONID,START,ENDDATE)
);

CREATE TABLE BIRTH(
  CHARACTERID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  BIRTH ENHANCEDDATE NOT NULL
);

CREATE TABLE DEATH(
  CHARACTERID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  DEATH ENHANCEDDATE NOT NULL
);

CREATE TABLE ATTENDS(
  CHARACTERID CHARACTER VARYING(10) NOT NULL,
  EVENTID CHARACTER VARYING(10) NOT NULL,
  PRIMARY KEY (CHARACTERID,EVENTID)
);

CREATE TABLE RELATIONLIST(
  RELATIONID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  RELATIONTYPE CHARACTER VARYING(42) NOT NULL 
);

CREATE TABLE EVENTNAME(
  EVENTID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  NAME CHARACTER VARYING(42) NOT NULL 
);

CREATE TABLE EVENTDESCRIPTION(
  EVENTID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  DESCRIPTION CHARACTER VARYING(42) NOT NULL 
);

CREATE TABLE ASSOCIATIONNAME(
  ASSOCIATIONID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  NAME CHARACTER VARYING(42) NOT NULL 
);

CREATE TABLE ASSOCIATIONDESCRIPTION(
  ASSOCIATIONID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  DESCRIPTION TEXT NOT NULL 
);

CREATE TABLE MAP(
  MAPID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  NUMWIDTH INTEGER NOT NULL,
  NUMLENGTH INTEGER NOT NULL,
  WIDTH DOUBLE PRECISION NOT NULL,
  LENGTH DOUBLE PRECISION NOT NULL
);

CREATE TABLE PLACE(
  PLACEID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  PLACENAME CHARACTER VARYING(42) NOT NULL 
);

CREATE TABLE SUBPLACE(
  PLACEID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  SQUAREID INTEGER NOT NULL,
  MAPID CHARACTER VARYING(10) NOT NULL
);

CREATE TABLE SQUAREID(
  PLACEID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  SQUAREID CHARACTER VARYING(10) NOT NULL
);

CREATE TABLE MAPPEDPLACE(
  PLACEID CHARACTER VARYING(10) PRIMARY KEY NOT NULL,
  MAPID CHARACTER VARYING(10) UNIQUE NOT NULL
);

CREATE TABLE EVENT(
  EVENTID CHARACTER VARYING(10) NOT NULL,
  PLACEID CHARACTER VARYING(10) NOT NULL,
  BEGINNING ENHANCEDDATE NOT NULL,
  ENDDATE ENHANCEDDATE NOT NULL,
  PRIMARY KEY (EVENTID,PLACEID,BEGINNING,ENDDATE)
);

ALTER TABLE ONLY ASSOCIATION
    ADD CONSTRAINT C1 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY ORIGINATES
    ADD CONSTRAINT C2 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY BEHAVIOR
    ADD CONSTRAINT C3 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY PSEUDO
    ADD CONSTRAINT C4 FOREIGN KEY (CALLERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY PSEUDO
    ADD CONSTRAINT C5 FOREIGN KEY (CALLEDID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY TIMELESSRELATION
    ADD CONSTRAINT C6 FOREIGN KEY (SOURCE) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY DATERELATION
    ADD CONSTRAINT C7 FOREIGN KEY (SOURCE) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY RANGERELATION
    ADD CONSTRAINT C8 FOREIGN KEY (SOURCE) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY TIMELESSRELATION
    ADD CONSTRAINT C9 FOREIGN KEY (TARGET) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY DATERELATION
    ADD CONSTRAINT C10 FOREIGN KEY (TARGET) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY RANGERELATION
    ADD CONSTRAINT C11 FOREIGN KEY (TARGET) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY BIRTH
    ADD CONSTRAINT C12 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY DEATH
    ADD CONSTRAINT C13 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY ATTENDS
    ADD CONSTRAINT C14 FOREIGN KEY (CHARACTERID) REFERENCES CHARACTER(CHARACTERID);

ALTER TABLE ONLY ASSOCIATION
    ADD CONSTRAINT C15 FOREIGN KEY (ASSOCIATIONID) REFERENCES ASSOCIATIONNAME(ASSOCIATIONID);

ALTER TABLE ONLY ASSOCIATIONDESCRIPTION
    ADD CONSTRAINT C16 FOREIGN KEY (ASSOCIATIONID) REFERENCES ASSOCIATIONNAME(ASSOCIATIONID);

ALTER TABLE ONLY ORIGINATES
    ADD CONSTRAINT C17 FOREIGN KEY (PLACEID) REFERENCES PLACE(PLACEID);

ALTER TABLE ONLY SUBPLACE
    ADD CONSTRAINT C18 FOREIGN KEY (PLACEID) REFERENCES PLACE(PLACEID);

ALTER TABLE ONLY MAPPEDPLACE
    ADD CONSTRAINT C19 FOREIGN KEY (PLACEID) REFERENCES PLACE(PLACEID);

ALTER TABLE ONLY EVENT
    ADD CONSTRAINT C20 FOREIGN KEY (PLACEID) REFERENCES PLACE(PLACEID);

ALTER TABLE ONLY TIMELESSRELATION
    ADD CONSTRAINT C21 FOREIGN KEY (RELATIONID) REFERENCES RELATIONLIST(RELATIONID);

ALTER TABLE ONLY DATERELATION
    ADD CONSTRAINT C22 FOREIGN KEY (RELATIONID) REFERENCES RELATIONLIST(RELATIONID);

ALTER TABLE ONLY RANGERELATION
    ADD CONSTRAINT C23 FOREIGN KEY (RELATIONID) REFERENCES RELATIONLIST(RELATIONID);

ALTER TABLE ONLY ATTENDS
    ADD CONSTRAINT C31 FOREIGN KEY (EVENTID) REFERENCES EVENTNAME(EVENTID);

ALTER TABLE ONLY EVENTDESCRIPTION
    ADD CONSTRAINT C32 FOREIGN KEY (EVENTID) REFERENCES EVENTNAME(EVENTID);

ALTER TABLE ONLY EVENT
    ADD CONSTRAINT C33 FOREIGN KEY (EVENTID) REFERENCES EVENTNAME(EVENTID);

ALTER TABLE ONLY MAPPEDPLACE
    ADD CONSTRAINT C34 FOREIGN KEY (MAPID) REFERENCES MAP(MAPID);

ALTER TABLE ONLY SUBPLACE
    ADD CONSTRAINT C35 FOREIGN KEY (MAPID) REFERENCES MAP(MAPID);
    
ALTER TABLE ONLY RANGERELATION
    ADD CONSTRAINT C36 CHECK (compare((START).year,(START).month,(START).day,(ENDDATE).year,(ENDDATE).month,(ENDDATE).day) <= 0);
    
ALTER TABLE ONLY EVENT
    ADD CONSTRAINT C37 CHECK (compare((BEGINNING).year,(BEGINNING).month,(BEGINNING).day,(ENDDATE).year,(ENDDATE).month,(ENDDATE).day) <= 0);
   
   
INSERT INTO  CHARACTER  VALUES  ('CH1', 'Pierre');
INSERT INTO  CHARACTER  VALUES  ('CH2', 'Jean');
INSERT INTO  CHARACTER  VALUES  ('CH3', 'Benjamin');
INSERT INTO  CHARACTER  VALUES  ('CH4', 'Paul');


INSERT INTO ASSOCIATIONNAME VALUES ('AS1','Les petits riens');
INSERT INTO ASSOCIATIONNAME VALUES ('AS2','Les scouts');

INSERT INTO ASSOCIATION VALUES ('CH2','AS1');
INSERT INTO ASSOCIATION VALUES ('CH1','AS2');

INSERT INTO PLACE VALUES ('PL1','Bruxelles');
INSERT INTO PLACE VALUES ('PL2','LLN');
INSERT INTO PLACE VALUES ('PL3','Reaumur');
INSERT INTO PLACE VALUES ('PL4','Intel Room');

INSERT INTO ORIGINATES VALUES ('CH1','PL1');
INSERT INTO ORIGINATES VALUES ('CH2','PL4');
INSERT INTO ORIGINATES VALUES ('CH3','PL2');
INSERT INTO ORIGINATES VALUES ('CH4','PL3');

INSERT INTO BEHAVIOR VALUES ('CH2','melancholic');

INSERT INTO PSEUDO VALUES ('CH1','CH2', 'Poulpy');
INSERT INTO PSEUDO VALUES ('CH1','CH3', 'Benji');

INSERT INTO RELATIONLIST VALUES ('REL1','likes');
INSERT INTO RELATIONLIST VALUES ('REL2','does not like');
INSERT INTO RELATIONLIST VALUES ('REL3','is father of');
INSERT INTO RELATIONLIST VALUES ('REL4','is son of');


INSERT INTO TIMELESSRELATION VALUES ('CH4','CH1', 'REL3');

INSERT INTO DATERELATION VALUES ('CH1','CH4', 'REL4', (1992,12,28));

INSERT INTO RANGERELATION VALUES ('CH1','CH3', 'REL1', (2002,12,9), (2007,7,13));
INSERT INTO RANGERELATION VALUES ('CH3','CH1', 'REL1', (2003,11,10), (2009,8,12));
INSERT INTO RANGERELATION VALUES ('CH2','CH3', 'REL2', (2003,11,10), (2009,8,12));

INSERT INTO BIRTH VALUES ('CH1',(1992,12,28));
INSERT INTO BIRTH VALUES ('CH2',(1992,4,1));
INSERT INTO BIRTH VALUES ('CH3',(1992,6,3));

INSERT INTO DEATH VALUES ('CH1',(2064,6,15));

INSERT INTO EVENTNAME VALUES ('EV1','The beer festival');

INSERT INTO ATTENDS VALUES ('CH2','EV1');

INSERT INTO EVENTDESCRIPTION VALUES ('EV1','blablablablablablablabla');

INSERT INTO ASSOCIATIONDESCRIPTION VALUES ('AS1','Donnez vos vieux vêtements aux plus demunis');

INSERT INTO MAP VALUES ('MA1', 10, 20, 5.0, 10.0);
INSERT INTO MAP VALUES ('MA2', 10, 10, 0.1, 0.1);

INSERT INTO MAPPEDPLACE VALUES ('PL2','MA1');
INSERT INTO MAPPEDPLACE VALUES ('PL3','MA2');

INSERT INTO SUBPLACE VALUES ('PL3', 5, 'MA1');
INSERT INTO SUBPLACE VALUES ('PL4', 10, 'MA2');

INSERT INTO EVENT VALUES ('EV1', 'PL2', (2014,3,8), (2014,3,18));


